# ====================
# Connections / Network
# ====================
listen_addresses = '*'

# 32GB での現実的な上限（Rails parallel + multi-db を想定）
# 400 は“ロック地獄”を増やしがちなので、まずは抑えるのが安定に効きます
max_connections = 200

# ====================
# Replication (必要なら維持)
# ====================
wal_level = replica
hot_standby = on
max_wal_senders = 10
max_replication_slots = 10
hot_standby_feedback = on

# ====================
# Test/Dev Performance (Durability-off)
# ====================
# WARNING: dev/test only
fsync = off
synchronous_commit = off
full_page_writes = off

# チェックポイント頻度を下げてスパイクを避ける
checkpoint_timeout = 30min
max_wal_size = 8GB
checkpoint_completion_target = 0.9
wal_compression = on

# ====================
# Memory
# ====================
# 32GB の 1/8〜1/4 程度が目安。まずは 4GB で十分効きます
shared_buffers = 4GB

# OS キャッシュも含め「だいたいこのくらいキャッシュ効くはず」をプランナに伝える
effective_cache_size = 24GB

# fixture / truncate / index 再作成が速くなる（並列を考え 512MB 程度に抑える）
maintenance_work_mem = 512MB

# 注意: work_mem は “接続ごと” ではなく “演算ごと” に増える。
# max_connections を 200 に抑えた前提で、まず 32MB が無難。
work_mem = 32MB

# ====================
# Parallelism / Workers (8 threads想定)
# ====================
# 環境差が大きいので保守的に。重い集計/JOIN があるなら効きます。
max_worker_processes = 8
max_parallel_workers = 8
max_parallel_workers_per_gather = 2

# ====================
# Anti-hang for Locks (fixture由来の無限待ち対策)
# ====================
# 「解除」ではなく「永遠に待たない」ための安全装置
deadlock_timeout = 1s
log_lock_waits = on
lock_timeout = 5s

# ====================
# Logging (I/O削減)
# ====================
log_statement = 'none'
log_duration = off
log_min_duration_statement = -1

# ====================
# Autovacuum (test向け：暴れにくく)
# ====================
autovacuum_max_workers = 2
autovacuum_naptime = 60s
