<%# Generate unique ID for this widget instance %>
<% widget_id = "cf-turnstile-#{SecureRandom.hex(4)}" %>
<% site_key = Rails.application.credentials.dig(:CLOUDFLARE, :TURNSTILE_SITE_KEY) || ENV["CLOUDFLARE_TURNSTILE_SITE_KEY"] %>

<% if site_key.blank? %>
  <div class="rounded-md bg-red-50 px-3 py-2 text-sm text-red-700">
    Cloudflare Turnstile site key is missing. Set credentials or CLOUDFLARE_TURNSTILE_SITE_KEY.
  </div>
<% else %>
  <div id="<%= widget_id %>"></div>

  <script nonce="<%= content_security_policy_nonce %>">
    (function () {
        const widgetId = <%= widget_id.to_json %>;
        const container = document.getElementById(widgetId);

        if (!container) {
            console.error('Turnstile container not found:', widgetId);
            return;
        }

        function renderWidget() {
            if (typeof turnstile === 'undefined') {
                console.debug('Turnstile API not loaded yet, retrying...');
                setTimeout(renderWidget, 100);
                return;
            }

            console.debug('Rendering Turnstile widget in:', widgetId);

            try {
                turnstile.render('#' + widgetId, {
                    sitekey: <%= site_key.to_json %>,
                    callback: function (token) {
                        console.debug('Turnstile verified:', token.substring(0, 20) + '...');
                    },
                    'error-callback': function () {
                        console.error('Turnstile error occurred');
                    },
                    'expired-callback': function () {
                        console.debug('Turnstile token expired');
                    },
                });
            } catch (e) {
                console.error('Turnstile render error:', e);
            }
        }

        // Load script if not already loaded
        if (!window.turnstileScriptLoading && !window.turnstileScriptLoaded) {
            console.debug('Loading Turnstile script...');
            window.turnstileScriptLoading = true;

            const script = document.createElement('script');
            script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit';
            script.async = true;
            script.onload = function () {
                console.debug('Turnstile script loaded');
                window.turnstileScriptLoaded = true;
                window.turnstileScriptLoading = false;
                renderWidget();
            };
            script.onerror = function () {
                console.error('Failed to load Turnstile script');
                window.turnstileScriptLoading = false;
            };
            document.head.appendChild(script);
        } else if (window.turnstileScriptLoaded) {
            console.debug('Turnstile script already loaded');
            renderWidget();
        } else {
            console.debug('Turnstile script loading in progress, waiting...');
            const checkInterval = setInterval(function () {
                if (window.turnstileScriptLoaded) {
                    clearInterval(checkInterval);
                    renderWidget();
                }
            }, 100);
        }
    })();
</script>
<% end %>
